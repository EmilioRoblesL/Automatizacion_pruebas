name: Performance - k6

on:
  workflow_dispatch:

jobs:
  k6:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Preparar carpeta de mÃ©tricas
        run: mkdir -p performance

      - name: Ejecutar prueba de performance con k6 (Docker) + export JSON
        run: |
          docker run --rm -i -v ${{ github.workspace }}:/work -w /work grafana/k6 run \
            --summary-export=performance/k6-summary.json \
            performance/login_test.js | tee k6-output.txt

      - name: Verificar archivos generados
        run: |
          echo "Contenido carpeta performance:"
          ls -la performance
          echo "Archivo k6-output.txt:"
          ls -la k6-output.txt

      - name: Subir mÃ©tricas de performance (TXT + JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            k6-output.txt
            performance/k6-summary.json

      - name: Dashboard de Performance (Job Summary)
        if: always()
        run: |
          echo "## ðŸ“Š Dashboard de Performance (k6)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Script ejecutado: performance/login_test.js" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: **k6-performance-results** (incluye TXT + JSON)" >> $GITHUB_STEP_SUMMARY
